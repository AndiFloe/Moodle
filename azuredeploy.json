{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "sshPublicKey": {
            "metadata": {
                "description": "SSH public key used to secure access to the cluster. This can be used to login to the servers for debugging and maintenance."
            },
            "type": "string"
        },
        "sshUsername": {
            "defaultValue": "azureadmin",
            "metadata": {
                "description": "SSH username used to secure access to the cluster. This can be used to login to the servers for debugging and maintenance."
            },
            "type": "string"
        },
        "azureBackupSwitch": {
            "defaultValue": false,
            "metadata": {
                "description": "Switch to configure AzureBackup and enlist VM's. Setting this to true will ensure your cluster is backed up but will incur a cost. See https://azure.microsoft.com/services/backup/ for more details."
            },
            "type": "bool"
        },
        "redisDeploySwitch": {
            "defaultValue": true,
            "metadata": {
                "description": "Switch to deploy a Redis cache or not. Setting this to true can significantly improve performance of your cluster, but will incur a cost. It is not required for low traffic Moodle sites. See https://azure.microsoft.com/services/cache/ for more details."
            },
            "type": "bool"
        },
        "vnetGwDeploySwitch": {
            "defaultValue": false,
            "metadata": {
                "description": "Switch to deploy a Virtual Network Gateway or not. If you require VPN access to your cluster or communication with another Azure Virtual Network, you should set this to true. If you set this to true then you should review the `gateway*` parameters below to configure your gateway. VNet Gateways incur an additional cost. See https://docs.microsoft.com/azure/vpn-gateway/ for more information."
            },
            "type": "bool"
        },
        "installO365pluginsSwitch": {
            "defaultValue": false,
            "metadata": {
                "description": "Switch to install Moodle Office 365 plugins. These plugins provide a range of features for O365 user, including advanced single-sign-on functionality using configurable OpenID identity providers, including Azure Acitve Directory. These plugins are open source and do not incur any additional costs.. Connect See https://moodle.org/plugins/browse.php?list=set&id=72 for more information."
            },
            "type": "bool"
        },
        "storageAccountType": {
            "defaultValue": "Standard_LRS",
            "allowedValues": [
                "Standard_LRS",
                "Standard_ZRS",
                "Standard_GRS"
            ],
            "metadata": {
                "description": "Define the storage account type to be used. Three options exist, Locally Redundant Storage (LRS) is designed to provide 11 9's durability of objects over a given year, LRS data is replicated within a single data center. Zone Redundant Storage (ZRS) is designed to provide 12 9's durability, ZRS data is replicated across availability zones and should be used where downtime is not acceptable since it can continue to operate even when a single zone is unrecoverable. Geographically Redundant Storage (GRS) is designed to give 16 9's durability in a given year. GRS data is replicated across two regions at least 100 miles apart. In the event of a failure in one region Azure will fail-over to the second region. The higher the durability offered the higher the cost of your storage account. For more information see https://docs.microsoft.com/azure/storage/common/storage-introduction#pricing."
            },
            "type": "string"
        },
        "dbServerType": {
            "defaultValue": "mysql",
            "allowedValues": [
                "mysql",
                "mssql",
                "postgres"
            ],
            "metadata": {
                "description": "Select your preferred database type. Three databases, each offered as a service, are supported: MySQL, Postgres and MS SQL. The most commonly chosen option is MySQL. Each database has additional configuration options below. For more information about Azure Database for MySQL see https://azure.microsoft.com/services/mysql/, for Microsoft SQL see https://azure.microsoft.com/services/sql-database/ and for Postgres see https://azure.microsoft.com/services/postgresql/."
            },
            "type": "string"
        },
        "fileServerType": {
            "defaultValue": "gluster",
            "allowedValues": [
                "gluster",
                "nfs"
            ],
            "metadata": {
                "description": "Moodle files (the PHP source and Moodle Data) are stored on a fileserver. Gluster provides a replicated solution that is designed to provide higher avialbility, but incurs additional cost (it uses at least 2 additional VMs). Alternatively you can opt to use an NFS server which does not require an additional VM and is therefore cheaper, however, since it presents a single point of failure it may not be the preferred option. To further configure your fileserver see the `gluster*` and `fileserver` parameters below."
            },
            "type": "string"
        },
        "webServerType": {
            "defaultValue": "apache",
            "allowedValues": [
                "apache",
                "nginx"
            ],
            "metadata": {
                "description": "The PHP Moodle application can be served by wither Apache or NGinx. There is no difference in cost between the two. Apache is the more popular choice, but some people prefer NGinx. If Apache is used NGinx is still used for HTTPS termination."
            },
            "type": "string"
        },
        "controllerVmSku": {
            "defaultValue": "Standard_DS1_v2",
            "metadata": {
                "description": "The controller VM serves a number of purposes. It is used during deployment to bootstrap the cluster while at runtime it runs the Moodle Cron jobs, manages log information and acts as an SHH jumpbox should the cluster need to be debugged. If you select the NFS fileserver option it also acts as the fileserver. The size of this VM should reflect the expected demand on the machine. It can be resized later. For more information on VM sizes and prices see https://azure.microsoft.com/en-us/services/virtual-machines/."
            },
            "type": "string"
        },
        "autoscaleVmSku": {
            "defaultValue": "Standard_DS2_v2",
            "metadata": {
                "description": "The autoscale VMs provide a scalable Moodle web tier. These machines should be sized to accomodate expected load. Related parameters (below) allow the configuration of the autoscale parameters. For more information on VM sizes and prices see https://azure.microsoft.com/en-us/services/virtual-machines/."
            },
            "type": "string"
        },
        "autoscaleVmCount": {
            "defaultValue": 10,
            "metadata": {
                "description": "This sets a maximum limit to the number of autoscale VMs in the Web Tier. This should be setat a level high enough to ensure the web tier can scale to handle peak load, but low enough to prevent uncontrolled scaling in the event of DDOS or similar attacks."
            },
            "type": "int"
        },
        "installElasticSearchSwitch": {
            "defaultValue": false,
            "metadata": {
                "description": "Switch to install Moodle ElasticSearch plugins to allow Elastic Search to be used as an engine for Moodle's Global Search. Setting this switch to true will create an additional 3 VMs (of configurable size) and thus will incur additional charges. See https://moodle.org/plugins/search_elastic for more information."
            },
            "type": "bool"
        },
        "elasticVmSku": {
            "defaultValue": "Standard_DS2_v2",
            "metadata": {
                "description": "VM size for the elastic search nodes. This parameter is only used if `installElasticSearchSwitch` is set to true, in which case it defines the size of the three VMs used to provide Moodle Global Search using Elastic Search. For more information on VM sizes and prices see https://azure.microsoft.com/en-us/services/virtual-machines/."
            },
            "type": "string"
        },


        
        "firewallRuleName": {
            "defaultValue": "open-to-the-world",
            "metadata": {
                "description": "Database firewall rule name as it will appear in your Azure subscription. Under normal circumstances this need not be changed."
            },
            "type": "string"
        },
        "gatewaySubnet": {
            "allowedValues": [
                "GatewaySubnet"
            ],
            "defaultValue": "GatewaySubnet",
            "metadata": {
                "description": "Name for Virtual Network Gateway Subnet as it will appear in the Azure subscription. This is not used unless `vnetGwDeploySwitch` is set to true. Under normal circumstances this will not need to be changed."
            },
            "type": "string"
        },
        "gatewayType": {
            "allowedValues": [
                "Vpn",
                "ER"
            ],
            "defaultValue": "Vpn",
            "metadata": {
                "description": "If `vnetGwDeploySwitch is set to true this parameter will set the Virtual Network Gateway Type, it will be either Virtual Private Network (Vpn) or Express Route (ER). For more information see https://docs.microsoft.com/azure/vpn-gateway/."
            },
            "type": "string"
        },
        "glusterVmSku": {
            "defaultValue": "Standard_DS2_v2",
            "metadata": {
                "description": "VM size for the Gluster nodes. This parameter is only used if ``fileServerType` is set to 'gluster'. You should select a size that is appropriate for your expected load. For more information on VM sizes and prices see https://azure.microsoft.com/en-us/services/virtual-machines/."
            },
            "type": "string"
        },
        "fileServerDiskCount": {
            "defaultValue": 4,
            "minValue": 2,
            "maxValue": 8,
            "metadata": {
                "description": "Number of disks in raid0 per Gluster node or NFS server. The size of the disks is configurable via the `fileServerDiskSize` parameter. You should opt for an appropriate balance between number of disks, size of disks and price."
            },
            "type": "int"
        },        
        "fileServerDiskSize": {
            "defaultValue": 127,
            "metadata": {
                "description": "Size per disk for Gluster nodes or NFS server. The size of the disks is configurable via the `fileServerDiskSize` parameter. You should opt for an appropriate balance between number of disks, size of disks and price."
            },
            "type": "int"
        },
        "moodleVersion": {
            "allowedValues": [
                "MOODLE_34_STABLE",
                "MOODLE_33_STABLE",
                "MOODLE_32_STABLE",
                "MOODLE_31_STABLE",
                "MOODLE_30_STABLE",
                "MOODLE_29_STABLE"
            ],
            "defaultValue": "MOODLE_34_STABLE",
            "metadata": {
                "description": "The Moodle version you want to install."
            },
            "type": "string"
        },
        "dbLogin": {
            "defaultValue": "dbadmin",
            "metadata": {
                "description": "Database admin username. The password will be generated during install and will be available in the outputs of the deployment. See https://github.com/Azure/Moodle/blob/master/docs/Get-Install-Data.md for instructions for retrieving such information after deployment."
            },
            "type": "string"
        },
        "siteURL": {
            "defaultValue": "www.example.org",
            "metadata": {
                "description": "The URL for Moodle site. Moodle will be configured to use this URL if the value is changes. If the value is null or left as the default 'www.example.org' moodle will be configured to use the URL of the application cluster load balancer. This will be avialble as an output of the deployment. See https://github.com/Azure/Moodle/blob/master/docs/Get-Install-Data.md for retrieving such information after deployment."
            },
            "type": "string"
        },
        "skuCapacityDTU": {
            "allowedValues": [
                50,
                100,
                200,
                400,
                800
            ],
            "defaultValue": 100,
            "metadata": {
                "description": "Required Database Trasaction Units for MySQL or Postgres databases. This parameter is only used if `dbServerType` is set to 'mysql' or 'postgres'. DTU is a measure of the guaranteed level of resources for your database. It is a blended measure of CPU, memory, I/O (data and transaction log I/O). If your workload exceeds theselected amount of DTUs your throughput is throttled. It is important to selected a DTU level that can manage your workload without throttling but be aware that higher levels of DTUs will incur higher charges for your database. For more information on DTUs see https://docs.microsoft.com/azure/sql-database/sql-database-what-is-a-dtu."
            },
            "type": "int"
        },
        "skuFamily": {
            "allowedValues": [
                "SkuFamily"
            ],
            "defaultValue": "SkuFamily",
            "metadata": {
                "description": "MySql/Postgresql sku family. NOTE: this is likely an unused parameter that will be removed, see https://github.com/Azure/Moodle/issues/54."
            },
            "type": "string"
        },
        "skuName": {
            "allowedValues": [
                "PGSQLB50",
                "PGSQLB100",
                "PGSQLS100",
                "PGSQLS200",
                "PGSQLS400",
                "PGSQLS800",
                "MYSQLB50",
                "MYSQLB100",
                "MYSQLS100",
                "MYSQLS200",
                "MYSQLS400",
                "MYSQLS800"
            ],
            "defaultValue": "MYSQLS100",
            "metadata": {
                "description": "MySql/Postgresql SKU name. This defines the number of cores and the type of database created. For more information see https://docs.microsoft.com/azure/mysql/concepts-pricing-tiers."
            },
            "type": "string"
        },
        "skuSizeMB": {
            "defaultValue": 128000,
            "metadata": {
                "description": "MySql/Postgresql SKU size in MB. For Basic tier, minimum 50GB, increased by 125GB up to 1TB. For Standard tier, minimum 125GB, increase by 125GB up to 1TB. For more information see https://docs.microsoft.com/azure/mysql/concepts-pricing-tiers."
            },
            "type": "int"
        },
        "skuTier": {
            "allowedValues": [
                "Basic",
                "Standard"
            ],
            "defaultValue": "Standard",
            "metadata": {
                "description": "MySql/Postgres SKU tier. For more information see https://docs.microsoft.com/azure/mysql/concepts-pricing-tiers"
            },
            "type": "string"
        },
        "sslEnforcement": {
            "allowedValues": [
                "Disabled",
                "Enabled"
            ],
            "defaultValue": "Disabled",
            "metadata": {
                "description": "Enable or Disable MySql/Postgresql SSL connection."
            },
            "type": "string"
        },
        "postgresVersion": {
            "allowedValues": [
                "9.5",
                "9.6"
            ],
            "defaultValue": "9.6",
            "metadata": {
                "description": "Postgresql version"
            },
            "type": "string"
        },
        "mysqlVersion": {
            "allowedValues": [
                "5.6",
                "5.7"
            ],
            "defaultValue": "5.7",
            "metadata": {
                "description": "Mysql version"
            },
            "type": "string"
        },
        "serviceObjective": {
            "allowedValues": [
                "S1",
                "S2",
                "S3",
                "S4",
                "S5",
                "S6",
                "S7",
                "S9" 
            ],
            "defaultValue": "S1",
            "metadata": {
                "description": "Required Database Trasaction Units for MS SQL databases. This parameter is only used if `dbServerType` is set to 'mssql'. DTU is a measure of the guaranteed level of resources for your database. It is a blended measure of CPU, memory, I/O (data and transaction log I/O). If your workload exceeds theselected amount of DTUs your throughput is throttled. It is important to selected a DTU level that can manage your workload without throttling but be aware that higher levels of DTUs will incur higher charges for your database. For more information on DTUs see https://docs.microsoft.com/azure/sql-database/sql-database-what-is-a-dtu."
            },
            "type": "string"
        },
        "msDbSize": {
            "allowedValues": [
                "100MB",
                "250MB",
                "500MB",
                "1GB",
                "2GB",
                "5GB",
                "10GB",
                "20GB",
                "30GB",
                "40GB",
                "50GB",
                "100GB",
                "250GB",
                "300GB",
                "400GB",
                "500GB",
                "750GB",
                "1024GB"
            ],
            "defaultValue": "250GB",
            "metadata": {
                "description": "Required Database size for MS SQL databases. This parameter is only used if `dbServerType` is set to 'mssql'."
            },
            "type": "string"
        },
         "mssqlVersion": {
            "allowedValues": [
                "12.0"
            ],
            "defaultValue": "12.0",
            "metadata": {
                "description": "Mssql version"
            },
            "type": "string"
        },
        "vNetAddressSpace": {
            "defaultValue": "172.31.0.0",
            "metadata": {
                "description": "Address range for the Moodle virtual network - presumed /16."
            },
            "type": "string"
        },
        "vpnType": {
            "allowedValues": [
                "RouteBased",
                "PolicyBased"
            ],
            "defaultValue": "RouteBased",
            "metadata": {
                "description": "Virtual network gateway vpn type"
            },
            "type": "string"
        },        
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The base URI where artifacts required by this template are located. Under normal circumstances this will not be changed. If you want to create a customized version of these templates then change this parameter, otherwise leave as the default."
            },
            "defaultValue": "https://raw.githubusercontent.com/Azure/Moodle/master/"
        },
        "_artifactsLocationSasToken": {
            "type": "securestring",
            "metadata": {
                "description": "The sasToken required to access _artifactsLocation. Under normal circumstances this will not need to be changed."
            },
            "defaultValue": ""
        },
        "_applyScriptsSwitch": {
            "defaultValue": true,
            "metadata": {
                "description": "Switch to process or bypass all scripts/extensions. This is normally only used during testing, it prevents theinstallation and configuration of software on the resources, this results in a much faster deployment of allowing for easier validation of the infrastructure configuration."
            },
            "type": "bool"
        }
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "pid-738e3eec-68d4-4667-8377-c05c77c21f1b",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "dbTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl, parameters('dbServerType'), '.json', parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "condition": "[parameters('azureBackupSwitch')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "recoveryTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'recoveryservices.json',parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "condition": "[parameters('redisDeploySwitch')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "redisTemplate",
            "dependsOn": [
                "Microsoft.Resources/deployments/networkTemplate"
            ],
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'redis.json',parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "networkTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'network.json',parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "condition": "[parameters('installElasticSearchSwitch')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "dependsOn": [
                "Microsoft.Resources/deployments/networkTemplate",
                "Microsoft.Resources/deployments/recoveryTemplate"
            ],
            "name": "elasticTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'elastic.json',parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "condition": "[equals(parameters('fileServerType'),'gluster')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "dependsOn": [
                "Microsoft.Resources/deployments/networkTemplate",
                "Microsoft.Resources/deployments/recoveryTemplate"
            ],
            "name": "glusterTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'gluster.json',parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "dependsOn": [
                "Microsoft.Resources/deployments/elasticTemplate",
                "Microsoft.Resources/deployments/glusterTemplate",
                "Microsoft.Resources/deployments/recoveryTemplate",
                "Microsoft.Resources/deployments/networkTemplate",
                "Microsoft.Resources/deployments/dbTemplate",
                "Microsoft.Resources/deployments/redisTemplate",
                "Microsoft.Resources/deployments/storageAccountTemplate"
            ],
            "name": "controllerTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'controller.json',parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "dependsOn": [
                "Microsoft.Resources/deployments/controllerTemplate",
                "Microsoft.Resources/deployments/networkTemplate",
                "Microsoft.Resources/deployments/redisTemplate",
                "Microsoft.Resources/deployments/dbTemplate"
            ],
            "name": "scaleSetTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'webvmss.json',parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "storageAccountTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'storageAccount.json',parameters('_artifactsLocationSasToken'))]"
                }
            }
        }
    ],
    "outputs": {
      "siteURL": {
        "type": "string",
        "value": "[variables('moodleCommon').siteURL]"
      },
      "controllerInstanceIP": {
        "type": "string",
        "value": "[reference('controllerTemplate').outputs.controllerIP.value]"
      },
      "databaseDNS": {
        "type": "string",
        "value": "[variables('moodleCommon').dbDNS]"
      },
      "databaseAdminUsername": {
        "type": "string",
        "value": "[variables('moodleCommon').dbUsername]"
      },
      "databaseAdminPassword": {
        "type": "string",
        "value": "[variables('moodleCommon').dbLoginPassword]"
      },
      "firstFrontendVmIP": {
        "type": "string",
        "value": "[reference('scaleSetTemplate').outputs.webvm1IP.value]"
      },
      "moodleAdminPassword": {
        "type": "string",
        "value": "[variables('moodleCommon').moodleAdminPass]"
      },
      "moodleDbUsername": {
        "type": "string",
        "value": "[variables('moodleCommon').moodleDbUserAzure]"
      },
      "moodleDbPassword": {
        "type": "string",
        "value": "[variables('moodleCommon').moodleDbPass]"
      },
      "loadBalancerDNS": {
        "type": "string",
        "value": "[variables('moodleCommon').lbDns]"
      }
    },
    "variables": {
        "documentation01": "This main-template calls multiple sub-templates to create the moodle system",
        "documentation02": "    recoveryservices0   - dummy template (see next statement)",
        "documentation03": "    recoveryservices1   - creates a recovery vault that will be subsequently used by the VM Backup - a paramter swtich controls whethe is is called or bypassed",
        "documentation04": "    redis               - creates a redis cache",
        "documentation05": "    postgres / mysql  - creates a postgresql / mysql server",
        "documentation06": "    vnet                - creates a virtual network with three subnets",
        "documentation07": "    elastic             - creates a elastic search cluster on a vm farm",
        "documentation08": "    gluster             - creates a gluster file system on a vm farm",
        "documentation09": "    webvmss             - creates a vm scale set",
        "documentation10": "    controller          - creates a jumpbox and deploys code",
        "documentation11": "GlusterFS Sizing guidance",
        "moodleCommon": {
            "baseTemplateUrl": "[concat(parameters('_artifactsLocation'), 'nested/')]",
            "scriptLocation": "[concat(parameters('_artifactsLocation'), 'scripts/')]",
            "artifactsSasToken": "[parameters('_artifactsLocationSasToken')]",

            "applyScriptsSwitch": "[parameters('_applyScriptsSwitch')]",
            "autoscaleVmCount": "[parameters('autoscaleVmCount')]",
            "autoscaleVmSku": "[parameters('autoscaleVmSku')]",
            "azureBackupSwitch": "[parameters( 'azureBackupSwitch')]",
            "commonFunctionsScriptUri": "[concat(parameters('_artifactsLocation'),'scripts/helper_functions.sh',parameters('_artifactsLocationSasToken'))]",
            "controllerVmSku": "[parameters('controllerVmSku')]",
            "dbLogin": "[parameters('dbLogin')]",
            "dbLoginPassword": "[concat(substring(uniqueString(resourceGroup().id, deployment().name), 2, 11), '*7', toUpper('pfiwb'))]",
            "dbServerType": "[parameters('dbServerType')]",
            "dbUsername": "[concat(parameters('dbLogin'), '@', parameters('dbServerType'), '-', variables('resourceprefix'))]",
            "elasticVmSku": "[parameters('elasticVmSku')]",
            "dbDNS": "[if(equals(parameters('dbServerType'),'mssql'),concat(parameters('dbServerType'), '-',variables('resourcePrefix'), '.database.windows.net'), concat(parameters('dbServerType'), '-', variables('resourcePrefix'), '.', parameters('dbServerType'), '.database.azure.com'))]",
            "elasticAvailabilitySetName": "[concat('elastic-avset-',variables('resourceprefix'))]",
            "elasticClusterName": "[concat('es-cluster-',variables('resourceprefix'))]",
            "elasticNicName1": "[concat('elastic-vm-nic-01-',variables('resourceprefix'))]",
            "elasticNicName2": "[concat('elastic-vm-nic-02-',variables('resourceprefix'))]",
            "elasticNicName3": "[concat('elastic-vm-nic-03-',variables('resourceprefix'))]",
            "elasticScriptFilename": "install_elastic.sh",
            "elasticVm1IP": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),4)), '.20')]",
            "elasticVm2IP": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),4)), '.21')]",
            "elasticVm3IP": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),4)), '.22')]",
            "elasticVmName": "[concat('elastic-vm-',variables('resourceprefix'))]",
            "elasticVmName1": "[concat('elastic-vm-01-',variables('resourceprefix'))]",
            "elasticVmName2": "[concat('elastic-vm-02-',variables('resourceprefix'))]",
            "elasticVmName3": "[concat('elastic-vm-03-',variables('resourceprefix'))]",
            "extBeName": "[concat('lb-backend-',variables('resourceprefix'))]",
            "extFeName": "[concat('lb-frontend-',variables('resourceprefix'))]",
            "extNatPool": "[concat('lb-natpool-',variables('resourceprefix'))]",
            "extProbe": "[concat('lb-probe-',variables('resourceprefix'))]",
            "fileServerDiskCount": "[parameters('fileServerDiskCount')]",
            "fileServerDiskSize": "[parameters('fileServerDiskSize')]",
            "fileServerType": "[parameters('fileServerType')]",
            "firewallRuleName": "[parameters('firewallRuleName')]",
            "gatewayName": "[concat('vnet-gateway-',variables('resourceprefix'))]",
            "gatewayPublicIPName": "[concat('vnet-gw-ip-',variables('resourceprefix'))]",
            "gatewaySubnet": "[parameters('gatewaySubnet')]",
            "gatewaySubnetPrefix": "[concat(variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),2)))]",
            "gatewaySubnetRange": "[concat(variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),2)), '.0/24')]",
            "gatewayType": "[parameters('gatewayType')]",
            "gfsNameRoot": "[concat('gluster-vm-',variables('resourceprefix'))]",
            "gfxAvailabilitySetName": "[concat('gluster-avset-',variables('resourceprefix'))]",
            "glusterScriptFilename": "install_gluster.sh",
            "glusterVmCount": 2,
            "glusterVmSku": "[parameters('glusterVmSku')]",
            "installO365pluginsSwitch": "[parameters('installO365pluginsSwitch')]",
            "installElasticSearchSwitch": "[parameters('installElasticSearchSwitch')]",
            "jboxNicName": "[concat('jumpbox-vm-nic-',variables('resourceprefix'))]",
            "jboxNsgName": "[concat('jumpbox-nsg-',variables('resourceprefix'))]",
            "jboxPipName": "[concat('jumpbox-pubip-',variables('resourceprefix'))]",
            "jboxVmName": "[concat('jumpbox-vm-',variables('resourceprefix'))]",
            "lbDns": "[concat('lb-',variables('resourceprefix'),'.',resourceGroup().location,'.cloudapp.azure.com')]",
            "lbName": "[concat('lb-',variables('resourceprefix'))]",
            "lbPipName": "[concat('lb-pubip-',variables('resourceprefix'))]",
            "moodleAdminPass": "[concat(toUpper('xl'), substring(uniqueString(resourceGroup().id, deployment().name), 6, 7),',1*8')]",
            "moodleDbName": "moodle",
            "moodleDbPass": "[concat('9#36^', substring(uniqueString(resourceGroup().id, deployment().name), 5, 8), toUpper('ercq'))]",
            "moodleDbUser": "moodle",
            "moodleDbUserAzure": "[concat('moodle', '@', parameters('dbServerType'), '-', variables('resourceprefix'))]",
            "moodleInstallScriptFilename": "install_moodle.sh",
            "moodleVersion": "[parameters('moodleVersion')]",
            "msDbSize": "[parameters('msDbSize')]",
            "mssqlVersion": "[parameters('mssqlVersion')]",
            "mysqlVersion": "[parameters('mysqlVersion')]",
            "osType": {
                "offer": "UbuntuServer",
                "publisher": "Canonical",
                "sku": "16.04-LTS",
                "version": "latest"
            },
            "policyName": "[concat('policy-',variables('resourceprefix'))]",
            "postgresVersion": "[parameters('postgresVersion')]",
            "redisCacheName": "[concat('redis-',variables('resourceprefix'))]",
            "redisDeploySwitch": "[parameters('redisDeploySwitch')]",
            "redisDns": "[concat('redis-',variables('resourceprefix'),'.redis.cache.windows.net')]",
            "resourcesPrefix": "[variables('resourceprefix')]",
            "serviceObjective": "[parameters('serviceObjective')]",
            "serverName": "[concat(parameters('dbServerType'), '-',variables('resourceprefix'))]",
            "siteURL": "[if(or(empty(parameters('siteURL')), equals(parameters('siteURL'), 'www.example.org')), concat('lb-',variables('resourceprefix'),'.',resourceGroup().location,'.cloudapp.azure.com'), parameters('siteURL'))]",
            "skuCapacityDTU": "[parameters('skuCapacityDTU')]",
            "skuFamily": "[parameters('skuFamily')]",
            "skuName": "[parameters('skuName')]",
            "skuSizeMB": "[parameters('skuSizeMB')]",
            "skuTier": "[parameters('skuTier')]",
            "sshPublicKey": "[parameters('sshPublicKey')]",
            "sshUsername": "[parameters('sshUsername')]",
            "sslEnforcement": "[parameters('sslEnforcement')]",
            "storageAccountName": "[tolower(concat('abs',variables('resourceprefix')))]",
            "storageAccountType": "[parameters('storageAccountType')]",
            "subnetElastic": "[concat('elastic-subnet-',variables('resourceprefix'))]",
            "subnetElasticPrefix": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),4)))]",
            "subnetElasticRange": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),4)), '.0/24')]",
            "subnetRedis": "[concat('redis-subnet-',variables('resourceprefix'))]",
            "subnetRedisPrefix": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),3)))]",
            "subnetRedisRange": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),3)), '.0/24')]",
            "subnetSan": "[concat('san-subnet-',variables('resourceprefix'))]",
            "subnetSanPrefix": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),1)))]",
            "subnetSanRange": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),1)), '.0/24')]",
            "subnetWeb": "[concat('web-subnet-',variables('resourceprefix'))]",
            "subnetWebPrefix": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),0)))]",
            "subnetWebRange": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),0)), '.0/24')]",
            "vNetAddressSpace": "[parameters('vNetAddressSpace')]",
            "vaultName": "[concat('vault-',variables('resourceprefix'))]",
            "vmssName": "[concat('vmss-',variables('resourceprefix'))]",
            "vmssdStorageAccounttName": "[concat('vmss',uniqueString(resourceGroup().id))]",
            "vnetGwDeploySwitch": "[parameters('vnetGwDeploySwitch')]",
            "vnetName": "[concat('vnet-',variables('resourceprefix'))]",
            "vpnType": "[parameters('vpnType')]",
            "webServerSetupScriptFilename": "setup_webserver.sh",
            "webServerType": "[parameters('webServerType')]"
        },
        "octets": "[split(parameters('vNetAddressSpace'), '.')]",
        "resourceprefix": "[substring(uniqueString(resourceGroup().id, deployment().name), 3, 6)]"
    }
}
